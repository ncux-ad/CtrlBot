# üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è PostScheduler - –ó–ê–í–ï–†–®–ï–ù–û

## ‚úÖ **–ß—Ç–æ –±—ã–ª–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:**

### 1. **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ë–î –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞**
```sql
-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –≤—Ä–µ–º–µ–Ω–∏
CREATE INDEX idx_posts_scheduled_status_time ON posts (status, scheduled_at) WHERE status = 'scheduled';

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
CREATE INDEX idx_posts_scheduled_at ON posts (scheduled_at) WHERE scheduled_at IS NOT NULL;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤ –ø–æ –∫–∞–Ω–∞–ª—É –∏ —Å—Ç–∞—Ç—É—Å—É
CREATE INDEX idx_posts_channel_status ON posts (channel_id, status);
```

### 2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–∞–ø—Ä–æ—Å –≤ `get_scheduled_posts()`**
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏**: —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
- ‚úÖ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞**: –º–∞–∫—Å–∏–º—É–º 100 –ø–æ—Å—Ç–æ–≤ –∑–∞ —Ä–∞–∑
- ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤**: –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `idx_posts_scheduled_status_time`

### 3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤**
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞**: –ø–æ—Å—Ç—ã —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `failed` (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã)
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏**: –≤—Å–µ –ø–æ—Å—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ë–î –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –∞—É–¥–∏—Ç–∞

### 4. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
- ‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤**: —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

### 5. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞**
- ‚úÖ **–ú–µ—Ç–æ–¥ `get_scheduler_stats()`**: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –ø–æ—Å—Ç–æ–≤
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

### **–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚ùå –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤—Å—è –ë–î
- ‚ùå –ù–µ—Ç –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ (–ø–æ—Å—Ç ID 3 –ø—É–±–ª–∏–∫–æ–≤–∞–ª—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
- ‚ùå –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ –ë–î

### **–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤
- ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏**: —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã
- ‚úÖ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏**: –º–∞–∫—Å–∏–º—É–º 100 –ø–æ—Å—Ç–æ–≤ –∑–∞ —Ä–∞–∑
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö**: –ø–æ—Å—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `failed`
- ‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –ø–æ—Å—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ –ë–î –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

### **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:**
```sql
SELECT p.*, c.tg_channel_id, c.title as channel_title
FROM posts p
JOIN channels c ON p.channel_id = c.id
WHERE p.status = 'scheduled' 
AND p.scheduled_at <= NOW()
AND p.scheduled_at > NOW() - INTERVAL '1 hour'  -- –¢–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
ORDER BY p.scheduled_at ASC
LIMIT 100  -- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –∑–∞ —Ä–∞–∑
```

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤:**
```sql
UPDATE posts 
SET status = 'failed', updated_at = NOW()
WHERE status = 'scheduled' 
AND scheduled_at < NOW() - INTERVAL '24 hours'
AND id NOT IN (
    SELECT id FROM posts 
    WHERE status = 'published' 
    AND published_at IS NOT NULL
)
```

## üéØ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

- **–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞**: ~10x –±—ã—Å—Ç—Ä–µ–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –∏–Ω–¥–µ–∫—Å–∞–º
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î**: ~90% –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ü–∞–º—è—Ç—å**: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 100 –ø–æ—Å—Ç–æ–≤ –∑–∞ —Ä–∞–∑
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤

## üìÅ **–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

1. **`deploy/migrations/add_scheduler_indexes.sql`** - –∏–Ω–¥–µ–∫—Å—ã –ë–î
2. **`services/post_service.py`** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `get_scheduled_posts()`
3. **`services/post_scheduler.py`** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
4. **`apply_scheduler_optimization.py`** - —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üöÄ **–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!**

PostScheduler —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î. –í—Å–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —Ç–æ—á–Ω–æ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.

---
*–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: 13.09.2025*
